{% extends "base.html" %}

{% load static %}
{% block title %}进度记录{% endblock %}
{% block head %}

{% endblock %}

{% block content %}

    <div class="weui-cells weui-cells_form sc_top">
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <textarea class="weui-textarea" placeholder="写下过程，打卡记录" rows="3"></textarea>
                <div class="weui-uploader__bd" id="preview_wrapper">
                    <form action="/weixin/save_history/" method="POST" enctype="multipart/form-data">

            <div class="updateImg">
            </div>

            <input name="photo" type="file" id="exampleInputFile" onchange="onUploadImgChange(this)">
            <button id="photo" class="btn btn-danger" type="submit">上传头像</button>
                    </form>

                </div>
            </div>
        </div>
    </div>




    <script src="{% static 'js/jquery-3.2.1.js' %}"></script>

    <script>
        $.ajaxSetup({data: {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }});

        function onUploadImgChange(sender)
        {
            if( !sender.value.match( /.jpg|.gif|.png|.jpeg|.bmp/i ) ){
                alert('图片格式无效！');
                return false;
            }

            for(var i=0; i< sender.files.length; i++)
            {
                var image_path =  window.URL.createObjectURL(sender.files[i]);
                var content = '<ul class="weui-uploader__files" id="uploaderFiles">\n' +
                '                            <li class="weui-uploader__file "><img class="sc_t" id="upload_files" src="' + image_path + '" alt="过程记录图"></li>\n' +
                '                         </ul>';
                $("#images").append(content);
            }

        }

        function save_history() {
            var goal_id = '{{ goal_id }}';
            var history_content = $('.weui-textarea').val();
            var image_urls = document.getElementsByClassName('sc_t');
            var image_url = '';
            for(var i=0; i<image_urls.length;i++)
            {
                if(image_url==='')
                {
                    image_url = image_urls[i].src;
                }
                else
                {
                    image_url = image_url + ';' + image_urls[i].src;
                }

            }

            $.ajax({
                type:"post",
                url:"/weixin/save_history/",//自己填写请求地址
                data:{goal_id: goal_id, history_content: history_content, image_url: image_url},
                success:function(result){
                    var res = result.split('&')[0];
                    if(res === 'True')
                    {
                        $.message({
                            message:'执行记录添加成功, 即将跳转到目标详情页面',
                            time:'3000'
                        });
                        location.href = '/weixin/goaldetail/' + goal_id + '/';
                    }
                    else
                    {
                        alert('服务器故障，请稍后再试');
                    }
                }
            });

        }



    </script>


{% endblock %}